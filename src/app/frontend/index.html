<!--
Copyright 2017 The Kubernetes Dashboard Authors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html ng-app="kubernetesDashboard">
<!-- TODO(bryk): Add ng-strict-di setting for production builds. -->

<head>
  <meta charset="utf-8">
  <title ng-controller="kdTitle as $ctrl"
         ng-bind="$ctrl.title()"></title>
  <link rel="icon"
        type="image/png"
        href="assets/images/kubernetes-logo.png" />
  <meta name="viewport"
        content="width=device-width">

  <!-- build:css static/vendor.css -->
  <!-- bower:css -->
  <!-- Bower CSS dependencies are populated here (dev build) and compiled
         into vendor.css (prod build). -->
  <!-- endbower -->
  <!-- endbuild -->

  <!-- build:css static/app.css -->
  <!-- inject:css -->
  <!-- Application css files are populated here (dev build) and compiled
         into app.css (prod build). -->
  <!-- endinject -->
  <!-- endbuild -->
</head>
<body ng-controller="kdMain as $ctrl">
  <!--[if lt IE 10]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser.
      Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your
      experience.</p>
    <![endif]-->

  <kd-login layout="column"
            layout-fill
            ng-if="$ctrl.isLoginState()">
  </kd-login>
  <kd-chrome layout="column"
             layout-fill
             ng-if="!$ctrl.isLoginState()">
    <!-- Application content is inserted here. -->
  </kd-chrome>
  <!-- build:js static/vendor.js -->
  <!-- bower:js -->
  <script src="http://maps.google.com/maps/api/js"></script>
  <!-- Bower JS dependencies are populated here (dev build) and compiled
         into vendor.js (prod build). -->
  <!-- endbower -->
  <!-- endbuild -->

  <!-- Script with configuration generated at backend. -->
  <script src="api/appConfig.json" class=''></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <div id="map" style="width:100%;height:400px;background:yellow"></div>
  <script>

    var map;
    var nodes = [];

    function callAPI() {
    	var xmlhttp = new XMLHttpRequest();
    	var url = "http://140.114.79.70:8080/api/v1/nodes";

    	xmlhttp.onreadystatechange = function() {
      		if (this.readyState == 4 && this.status == 200) {
          		console.log("GET SUCCESS");
          		var myArr = JSON.parse(this.responseText);
          		var items = myArr.items

            //console.log(items.length);
      			for(i = 0; i < items.length; i++) {
      				var name = items[i].metadata.name
              console.log(name);

              var locationArr = items[i].metadata.labels.mylocation.split("_");
      				var lat = parseFloat(locationArr[0])
      				var lon = parseFloat(locationArr[1])

      				var podinfo = queryPods(name);
              var pod_name = [0], pod_status = [0];
              if (podinfo != null) {
      				      pod_name = podinfo[0], pod_status = podinfo[1];
              }
              //console.log("podinfo");

      				sensor = [items[i].metadata.labels.sensor1,items[i].metadata.labels.sensor2,items[i].metadata.labels.sensor3,items[i].metadata.labels.sensor4,items[i].metadata.labels.sensor5,items[i].metadata.labels.sensor6,items[i].metadata.labels.sensor7,items[i].metadata.labels.sensor8,items[i].metadata.labels.sensor9,items[i].metadata.labels.sensor10];
              //console.log("sensor");
              // //drawMarkers(name, lat, lon, pod_name, pod_status, sensor);
      				var node = {name:name, latL:lat, lon:lon, pod_name:pod_name, pod_status:pod_status, sensor:sensor};
      				// console.log(node);
      				nodes.push(node);
      			}
            for(j = 0; j < nodes.length; j++){
              console.log('draw '+nodes[j].name);
              drawMarkers(nodes[j].name, nodes[j].latL, nodes[j].lon, nodes[j].pod_name, nodes[j].pod_status, nodes[j].sensor);
            }
         }
    	};
    	xmlhttp.open("GET", url, false);
    	xmlhttp.send();

    }

    function queryPods(name) {
    	var pod_name = [], pod_status = [];
    	var xhr = new XMLHttpRequest(), method = "GET", url = "http://140.114.79.70:8080/api/v1/pods";
    	xhr.open(method, url, false);
    	xhr.onreadystatechange = function () {
      	if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
      		var myArr = JSON.parse(this.responseText);
    			var items = myArr.items
    			for(k = 0; k < items.length; k++) {
    				if(items[k].spec.nodeName == name){
    					//console.log(items[k].metadata.name)
    					pod_name[k] = String(items[k].metadata.name);
    					pod_status[k] = String(items[k].status.phase);
    				}
    			}
    			return [pod_name, pod_status];
            	}
            };
    	xhr.send();
    }

    function drawMarkers(name, lat, lon, pod_name, pod_status, sensor) {
        // console.log(lat);
        // console.log(lon);
        // console.log(name);
        // console.log(pod_name);
        // console.log(pod_status);

        var marker = new google.maps.Marker({
          position: new google.maps.LatLng(lat, lon),
          map: map,
          url: '/#!/node/'+name+'?namespace=default'
        });

        var contentString = '<div id="content">'+
          '<div id="siteNotice">'+
          '</div>'+
          '<h1 id="firstHeading" class="firstHeading">'+name+'</h1>'+
          '<div id="bodyContent">'+
          '<table border="1">'+
          　'<tr>'+
          　'<td colspan="4" align="center">Sensor Status</td>'+
          　'</tr>'+
          　'<tr>'+
          　'<td><b>Sensor 1</b></td>'+
          　'<td>'+sensor[0]+'</td>'+
          　'<td><b>Sensor 6</b></td>'+
          　'<td>'+sensor[5]+'</td>'+
          　'</tr>'+
          　'<tr>'+
          　'<td><b>Sensor 2</b></td>'+
          　'<td>'+sensor[1]+'</td>'+
          　'<td><b>Sensor 7</b></td>'+
          　'<td>'+sensor[6]+'</td>'+
          　'</tr>'+
          　'<tr>'+
          　'<td><b>Sensor 3</b></td>'+
          　'<td>'+sensor[2]+'</td>'+
          　'<td><b>Sensor 8</b></td>'+
          　'<td>'+sensor[7]+'</td>'+
          　'</tr>'+
          　'<tr>'+
          　'<td><b>Sensor 4</b></td>'+
          　'<td>'+sensor[3]+'</td>'+
          　'<td><b>Sensor 9</b></td>'+
          　'<td>'+sensor[8]+'</td>'+
          　'</tr>'+
          　'<tr>'+
          　'<td><b>Sensor 5</b></td>'+
          　'<td>'+sensor[4]+'</td>'+
          　'<td><b>Sensor 10</b></td>'+
          　'<td>'+sensor[9]+'</td>'+
          　'</tr>'+
         '</table>'+

         '<table border="1">'+
         　'<tr>'+
         　'<td colspan="2" align="center">Pods Status</td>'+
         　'</tr>';

        for(l = 0; l < pod_name.length; l++) {
          contentString = contentString+      　
            '<tr>'+
          　'<td><b>'+pod_name[l]+'</b></td>'+
          　'<td>'+pod_status[l]+'</td>'+
          　'</tr>'
        };

        contentString = contentString + '</table>'+'</div>'+'</div>';

        var infowindow = new google.maps.InfoWindow({
            content: contentString
        });

        marker.addListener('mouseover', function() {
          infowindow.open(map, this);
        });

        // assuming you also want to hide the infowindow when user mouses-out
        marker.addListener('mouseout', function() {
            infowindow.close();
        });

        google.maps.event.addListener(marker, 'click', function() {
          window.location.href = marker.url;
          $("html, body").animate({ scrollTop: 0 }, 600);
        });
    }

    function myMap() {
      var mapOptions = {
          center: new google.maps.LatLng(24.795211, 120.992309),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
  	      styles: [{"featureType":"administrative","elementType":"all","stylers":[{"visibility":"on"},{"lightness":33}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2e5d4"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#c5dac6"}]},{"featureType":"poi.park","elementType":"labels","stylers":[{"visibility":"on"},{"lightness":20}]},{"featureType":"road","elementType":"all","stylers":[{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#c5c6c6"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#e4d7c6"}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#fbfaf7"}]},{"featureType":"water","elementType":"all","stylers":[{"visibility":"on"},{"color":"#acbcc9"}]}]
      }

      map = new google.maps.Map(document.getElementById("map"), mapOptions);
      callAPI();
    }

  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8FLccDBYbLiPfGNvvplRAV3rgyCWmnaI&callback=myMap"></script>

  <!-- build:js static/app.js -->
  <!-- inject:js -->
  <!-- Application JS files are populated here. -->
  <!-- endinject -->
  <!-- endbuild -->
</body>
</html>
