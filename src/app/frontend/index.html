<!--
Copyright 2017 The Kubernetes Dashboard Authors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!doctype html>
<html ng-app="kubernetesDashboard">
<!-- TODO(bryk): Add ng-strict-di setting for production builds. -->

<head>
  <meta charset="utf-8">
  <title ng-controller="kdTitle as $ctrl"
         ng-bind="$ctrl.title()"></title>
  <link rel="icon"
        type="image/png"
        href="assets/images/kubernetes-logo.png" />
  <meta name="viewport"
        content="width=device-width">

  <!-- build:css static/vendor.css -->
  <!-- bower:css -->
  <!-- Bower CSS dependencies are populated here (dev build) and compiled
         into vendor.css (prod build). -->
  <!-- endbower -->
  <!-- endbuild -->

  <!-- build:css static/app.css -->
  <!-- inject:css -->
  <!-- Application css files are populated here (dev build) and compiled
         into app.css (prod build). -->
  <!-- endinject -->
  <!-- endbuild -->
</head>
<body ng-controller="kdMain as $ctrl">
  <!--[if lt IE 10]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser.
      Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your
      experience.</p>
    <![endif]-->

  <kd-login layout="column"
            layout-fill
            ng-if="$ctrl.isLoginState()">
  </kd-login>
  <kd-chrome layout="column"
             layout-fill
             ng-if="!$ctrl.isLoginState()">
    <!-- Application content is inserted here. -->
  </kd-chrome>
  <!-- build:js static/vendor.js -->
  <!-- bower:js -->
  <script src="http://maps.google.com/maps/api/js"></script>
  <!-- Bower JS dependencies are populated here (dev build) and compiled
         into vendor.js (prod build). -->
  <!-- endbower -->
  <!-- endbuild -->

  <!-- Script with configuration generated at backend. -->
  <script src="api/appConfig.json" class=''></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <style media="screen" type="text/css">

  .gm-style-iw {
  	width: 300px !important;
  	top: 15px !important;
  	left: 0px !important;
  	background-color: #fff;
  	box-shadow: 0 1px 6px rgba(178, 178, 178, 0.6);
  	border: 1px solid rgba(72, 181, 233, 0.6);
  	border-radius: 2px 2px 10px 10px;
  }
  #iw-container {
  	margin-bottom: 10px;
  }
  #iw-container .iw-title {
  	font-family: 'Open Sans Condensed', sans-serif;
    width: 300px;
  	font-size: 22px;
  	font-weight: 400;
  	padding: 10px;
  	background-color: #48b5e9;
  	color: white;
  	margin: 0;
  	border-radius: 2px 2px 0 0;
  }
  #iw-container .iw-content {
  	font-size: 13px;
  	line-height: 18px;
  	font-weight: 400;
  	margin-right: 1px;
  	padding: 15px 5px 20px 15px;
  	max-height: 200px;
  	overflow-y: auto;
  	overflow-x: hidden;
  }
  .iw-subTitle {
  	font-size: 16px;
  	font-weight: 700;
  	padding: 5px 0;
  }
  .iw-bottom-gradient {
  	position: absolute;
  	width: 300px;
  	height: 1px;
  	bottom: 5px;
  	right: 18px;
  	background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
  	background: -webkit-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
  	background: -moz-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
  	background: -ms-linear-gradient(top, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
  }

  </style>
  <div id="map" style="width:100%;height:600px;background:yellow"></div>
  <script>

    var map;
    var nodes = [];

    function callAPI() {
    	var xmlhttp = new XMLHttpRequest();
    	var url = "http://140.114.79.70:8080/api/v1/nodes";

    	xmlhttp.onreadystatechange = function() {
      		if (this.readyState == 4 && this.status == 200) {
          		//console.log("GET SUCCESS");
          		var myArr = JSON.parse(this.responseText);
          		var items = myArr.items

            //console.log(items.length);
      			for(i = 0; i < items.length; i++) {
      				var name = items[i].metadata.name
              console.log(name);

              var locationArr = items[i].metadata.labels.mylocation.split("_");
      				var lat = parseFloat(locationArr[0])
      				var lon = parseFloat(locationArr[1])

      				var podinfo = queryPods(name);
              var pod_name = [0], pod_status = [0];

              console.log("podinfo: "+ podinfo);
              if (podinfo != null) {
      				      pod_name = podinfo[0], pod_status = podinfo[1];
              }

              //console.log("sensor: "+ JSON.stringify(items[i].metadata.labels));
      				sensor = [items[i].metadata.labels['sensor/camera'],items[i].metadata.labels['sensor/pir'],items[i].metadata.labels['sensor/mq3'],items[i].metadata.labels['sensor/mq5'],items[i].metadata.labels['sensor/mq131'],items[i].metadata.labels['sensor/mq135'],items[i].metadata.labels['sensor/microphone'],items[i].metadata.labels['sensor/gps'],items[i].metadata.labels.sensor9,items[i].metadata.labels.sensor10];
              //console.log("sensor");
              // //drawMarkers(name, lat, lon, pod_name, pod_status, sensor);
      				var node = {name:name, latL:lat, lon:lon, pod_name:pod_name, pod_status:pod_status, sensor:sensor};
      				// console.log(node);
      				nodes.push(node);
      			}
            for(j = 0; j < nodes.length; j++){
              console.log('draw '+nodes[j].name);
              drawMarkers(nodes[j].name, nodes[j].latL, nodes[j].lon, nodes[j].pod_name, nodes[j].pod_status, nodes[j].sensor);
            }
         }
    	};
    	xmlhttp.open("GET", url, false);
    	xmlhttp.send();

    }

    function queryPods(name) {
    	var pod_name = [], pod_status = [];
    	var xhr = new XMLHttpRequest(), method = "GET", url = "http://140.114.79.70:8080/api/v1/pods";
    	xhr.open(method, url, false);
    	xhr.onreadystatechange = function () {
      	if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
      		var myArr = JSON.parse(this.responseText);
    			var items = myArr.items
          // have some bug here, array will store empty object, ex. all_pod_name: ,,pir-sensors-rpi3
    			for(k = 0; k < items.length; k++) {
    				if(items[k].spec.nodeName == name){
    					// console.log(items[k].metadata.name)
    					// pod_name[k] = String(items[k].metadata.name);
    					// pod_status[k] = String(items[k].status.phase);
              pod_name[k] = items[k].metadata.name;
              // console.log("pod_name: "+ items[k].metadata.name);
              pod_status[k] = items[k].status.phase;
              // console.log("pod_status: "+ items[k].status.phase);
    				}
    			}
          // console.log("all_pod_name: "+ pod_name);
          // console.log("all_pod_status: "+ pod_status);
          // console.log("podinfo[5] "+ [pod_name, pod_status]);
        }
      };
    	xhr.send();
      return [pod_name, pod_status];
    }

    function drawMarkers(name, lat, lon, pod_name, pod_status, sensor) {
        // console.log(lat);
        // console.log(lon);
        // console.log(name);
        // console.log(pod_name);
        // console.log(pod_status);
        //https://www.sanwebe.com/2013/10/google-map-v3-markers-and-infowindow-with-jquery
        var marker = new google.maps.Marker({
          position: new google.maps.LatLng(lat, lon),
          map: map,
          url: '/#!/node/'+name+'?namespace=default'
        });

        testString = '<div id="iw-container">'+
                '<div class="iw-title">'+name+'</div>' +
                  '<div class="iw-content">' +
                  '<table border="1">'+
                  　'<tr>'+
                  　'<td colspan="4" align="center">Sensor Status</td>'+
                  　'</tr>'+
                  　'<tr>'+
                  　'<td><b>camera</b></td>'+
                  　'<td>'+sensor[0]+'</td>'+
                  　'<td><b>pir</b></td>'+
                  　'<td>'+sensor[1]+'</td>'+
                  　'</tr>'+
                  　'<tr>'+
                  　'<td><b>mq3</b></td>'+
                  　'<td>'+sensor[2]+'</td>'+
                  　'<td><b>mq5</b></td>'+
                  　'<td>'+sensor[3]+'</td>'+
                  　'</tr>'+
                  　'<tr>'+
                  　'<td><b>mq131</b></td>'+
                  　'<td>'+sensor[4]+'</td>'+
                  　'<td><b>mq135</b></td>'+
                  　'<td>'+sensor[5]+'</td>'+
                  　'</tr>'+
                  　'<tr>'+
                  　'<td><b>microphone</b></td>'+
                  　'<td>'+sensor[6]+'</td>'+
                  　'<td><b>gps</b></td>'+
                  　'<td>'+sensor[7]+'</td>'+
                  　'</tr>'+
                  '</table>'+

                 '<table border="1">'+
                 　'<tr>'+
                 　'<td colspan="2" align="center">Pods Status</td>'+
                 　'</tr>'+
                 '</div>' +
                 '<div class="iw-bottom-gradient"></div>' +

                 '</div>';
              for(l = 0; l < pod_name.length; l++) {
                if (pod_name[l]!=null){
                  testString = testString+      　
                    '<tr>'+
                  　'<td><b>'+pod_name[l]+'</b></td>'+
                  　'<td>'+pod_status[l]+'</td>'+
                  　'</tr>'
                }
              };
              testString = testString + '</table>'+'</div>'+
              '<br /><a href="/#!/node/'+name+'?namespace=default" class="marker-link" >  --> Goto</a>' +
              '<br /><div class="iw-bottom-gradient"></div>'+'</div>';
;

        var contentString = $(testString);

        var infowindow = new google.maps.InfoWindow();
        infowindow.setContent(contentString[0]);

        prev_infowindow =false;
        marker.addListener('click', function() {
          if( prev_infowindow ) {
             prev_infowindow.close();
          }
          prev_infowindow = infowindow;
          infowindow.open(map, this);
        });


        // Event that closes the Info Window with a click on the map
        google.maps.event.addListener(map, 'click', function() {
          infowindow.close();
        });

         var markerLinkBtn   = contentString.find('a.marker-link')[0];
         google.maps.event.addDomListener(markerLinkBtn, "click", function(event) {
             $("html, body").animate({ scrollTop: 0 }, 600);
         });




        // // assuming you also want to hide the infowindow when user mouses-out
        // marker.addListener('mouseout', function() {
        //     infowindow.close();
        // });

        google.maps.event.addListener(infowindow, 'domready', function() {

          // Reference to the DIV that wraps the bottom of infowindow
          var iwOuter = $('.gm-style-iw');

          /* Since this div is in a position prior to .gm-div style-iw.
           * We use jQuery and create a iwBackground variable,
           * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
          */
          var iwBackground = iwOuter.prev();

          // Removes background shadow DIV
          iwBackground.children(':nth-child(2)').css({'display' : 'none'});

          // Removes white background DIV
          iwBackground.children(':nth-child(4)').css({'display' : 'none'});

          // Moves the infowindow 115px to the right.
          iwOuter.parent().parent().css({left: '115px'});

          // Moves the shadow of the arrow 76px to the left margin.
          iwBackground.children(':nth-child(1)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

          // Moves the arrow 76px to the left margin.
          iwBackground.children(':nth-child(3)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

          // Changes the desired tail shadow color.
          iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});

          // Reference to the div that groups the close button elements.
          var iwCloseBtn = iwOuter.next();

          // Apply the desired effect to the close button
          iwCloseBtn.css({opacity: '1', right: '38px', top: '3px', border: '7px solid #48b5e9', 'border-radius': '13px', 'box-shadow': '0 0 5px #3990B9'});

          // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
          if($('.iw-content').height() < 140){
            $('.iw-bottom-gradient').css({display: 'none'});
          }

          // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
          iwCloseBtn.mouseout(function(){
            $(this).css({opacity: '1'});
          });
        });

        // google.maps.event.addListener(marker, 'click', function() {
        //   window.location.href = marker.url;
        //   $("html, body").animate({ scrollTop: 0 }, 600);
        // });


    }

    function myMap() {
      var mapOptions = {
          center: new google.maps.LatLng(24.795211, 120.992309),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
  	      styles: [{"featureType":"administrative","elementType":"all","stylers":[{"visibility":"on"},{"lightness":33}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2e5d4"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#c5dac6"}]},{"featureType":"poi.park","elementType":"labels","stylers":[{"visibility":"on"},{"lightness":20}]},{"featureType":"road","elementType":"all","stylers":[{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#c5c6c6"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#e4d7c6"}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#fbfaf7"}]},{"featureType":"water","elementType":"all","stylers":[{"visibility":"on"},{"color":"#acbcc9"}]}]
      }

      map = new google.maps.Map(document.getElementById("map"), mapOptions);
      callAPI();
    }

  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8FLccDBYbLiPfGNvvplRAV3rgyCWmnaI&callback=myMap"></script>

  <!-- build:js static/app.js -->
  <!-- inject:js -->
  <!-- Application JS files are populated here. -->
  <!-- endinject -->
  <!-- endbuild -->
</body>
</html>
